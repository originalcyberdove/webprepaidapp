<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PowerPay | Prepaid Electricity System</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    .fade-in { animation: fadeIn .25s ease-in-out; }
    @keyframes fadeIn { from {opacity:0; transform:translateY(8px)} to {opacity:1; transform:translateY(0)} }
    .loader { border:3px solid #f3f3f3; border-top:3px solid #3b82f6; border-radius:50%; width:18px; height:18px; animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body class="bg-slate-100 min-h-screen font-sans text-slate-800">

  <nav class="bg-blue-900 text-white sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center gap-2">
        <i class="fa-solid fa-bolt text-yellow-400 text-2xl"></i>
        <span class="text-xl font-bold">PowerPay</span>
      </div>
      <div id="nav-links" class="hidden md:flex gap-6 items-center"></div>
      <button id="mobile-menu-btn" class="md:hidden"><i class="fa-solid fa-bars"></i></button>
    </div>
  </nav>

  <main id="app-container" class="container mx-auto px-4 py-8"></main>

  <footer class="bg-slate-800 text-slate-400 py-6 text-center text-sm">
    <p>&copy; 2025 PowerPay Systems</p>
  </footer>

  <!-- BUY TOKEN -->
  <div id="buy-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl w-full max-w-md p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold">Buy Electricity Token</h3>
        <button onclick="closeModal('buy-modal')"><i class="fa-solid fa-times"></i></button>
      </div>
      <form onsubmit="handleBuyToken(event)">
        <input type="hidden" id="buy-meter-id"/>
        <div class="mb-3">
          <label class="block text-sm">Meter Number</label>
          <input id="buy-meter-number" disabled class="w-full border rounded px-3 py-2 bg-gray-100"/>
        </div>
        <div class="mb-4">
          <label class="block text-sm">Amount ($)</label>
          <input id="buy-amount" type="number" min="5" step="0.01" required class="w-full border rounded px-3 py-2"/>
          <p class="text-xs text-gray-500 mt-1">Min $5.00</p>
        </div>
        <div class="flex justify-end gap-3">
          <button type="button" class="px-4 py-2" onclick="closeModal('buy-modal')">Cancel</button>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded flex items-center">
            <span id="buy-btn-text">Confirm</span>
            <div id="buy-loader" class="loader ml-2 hidden"></div>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- RECEIPT -->
  <div id="receipt-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl w-full max-w-sm p-6 text-center">
      <h3 class="text-xl font-bold mb-2">Purchase Successful</h3>
      <p class="text-sm text-gray-600 mb-4">Token generated</p>
      <div class="bg-slate-100 p-4 rounded mb-4">
        <div class="text-xs text-gray-400">Token</div>
        <div id="receipt-token" class="font-mono font-bold text-lg">—</div>
      </div>
      <div class="grid grid-cols-2 gap-4 text-sm mb-4">
        <div>
          <div class="text-xs text-gray-400">Units Added</div>
          <div id="receipt-units" class="font-bold">0.00</div>
        </div>
        <div>
          <div class="text-xs text-gray-400">Cost</div>
          <div id="receipt-cost" class="font-bold">$0.00</div>
        </div>
      </div>
      <button class="bg-blue-600 text-white px-4 py-2 rounded" onclick="closeModal('receipt-modal'); loadDashboard();">Done</button>
    </div>
  </div>

  <!-- ADD METER -->
  <div id="add-meter-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl w-full max-w-md p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold">Add New Meter</h3>
        <button onclick="closeModal('add-meter-modal')"><i class="fa-solid fa-times"></i></button>
      </div>
      <form id="add-meter-form" onsubmit="handleAddMeter(event)">
        <div class="mb-3">
          <label class="block text-sm">Meter Number</label>
          <input id="new-meter-number" required class="w-full border rounded px-3 py-2"/>
        </div>
        <div class="mb-3">
          <label class="block text-sm">Meter Type</label>
          <select id="new-meter-type" required class="w-full border rounded px-3 py-2">
            <option value="">Select type</option>
            <option>Single Phase</option>
            <option>Three Phase</option>
            <option>Split Phase</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block text-sm">Installation Address (optional)</label>
          <input id="new-meter-address" class="w-full border rounded px-3 py-2"/>
        </div>
        <div class="flex justify-end gap-3">
          <button type="button" onclick="closeModal('add-meter-modal')" class="px-4 py-2">Cancel</button>
          <button type="submit" id="add-meter-btn" class="bg-blue-600 text-white px-4 py-2 rounded">Add Meter</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:5000/api';
    let currentUser = null;
    let userMeters = [];
    let usageChart = null;

    document.addEventListener('DOMContentLoaded', () => {
      const stored = localStorage.getItem('powerpay_user');
      if (stored) {
        currentUser = JSON.parse(stored);
        renderNav();
        loadDashboard();
      } else {
        renderNav();
        renderLogin();
      }
    });

    function renderNav(){
      const nav = document.getElementById('nav-links');
      if (currentUser) {
        nav.innerHTML = `<span class="text-blue-200 text-sm">Welcome, ${currentUser.full_name}</span>
                         <a href="#" onclick="loadDashboard()">Dashboard</a>
                         <button onclick="logout()" class="bg-red-500 text-white px-3 py-1 rounded">Logout</button>`;
      } else {
        nav.innerHTML = `<a href="#" onclick="renderLogin()">Login</a>
                         <a href="#" onclick="renderRegister()" class="bg-yellow-500 px-3 py-1 rounded text-blue-900">Register</a>`;
      }
    }

    function logout(){
      currentUser = null;
      localStorage.removeItem('powerpay_user');
      renderNav();
      renderLogin();
    }

    function renderLogin(){
      const c = document.getElementById('app-container');
      c.innerHTML = `
        <div class="max-w-md mx-auto bg-white p-6 rounded shadow fade-in">
          <h2 class="text-xl font-bold mb-4">Login</h2>
          <form onsubmit="handleLogin(event)">
            <div class="mb-3">
              <label class="block text-sm">Email</label>
              <input id="login-email" type="email" required class="w-full border px-3 py-2"/>
            </div>
            <div class="mb-4">
              <label class="block text-sm">Password</label>
              <input id="login-password" type="password" required class="w-full border px-3 py-2"/>
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded">Sign In</button>
          </form>
          <p class="text-sm mt-3">Don't have an account? <a href="#" onclick="renderRegister()" class="text-blue-600">Register</a></p>
        </div>`;
    }

    function renderRegister(){
      const c = document.getElementById('app-container');
      c.innerHTML = `
        <div class="max-w-md mx-auto bg-white p-6 rounded shadow fade-in">
          <h2 class="text-xl font-bold mb-4">Register</h2>
          <form onsubmit="handleRegister(event)">
            <div class="mb-2"><label class="block text-sm">Full Name</label><input id="reg-name" required class="w-full border px-3 py-2"/></div>
            <div class="mb-2"><label class="block text-sm">Email</label><input id="reg-email" type="email" required class="w-full border px-3 py-2"/></div>
            <div class="mb-2"><label class="block text-sm">Phone</label><input id="reg-phone" required class="w-full border px-3 py-2"/></div>
            <div class="mb-4"><label class="block text-sm">Password</label><input id="reg-password" type="password" required class="w-full border px-3 py-2"/></div>
            <button type="submit" class="w-full bg-yellow-500 text-blue-900 py-2 rounded">Register</button>
          </form>
        </div>`;
    }

    // --- Dashboard: loads from backend every time
    async function loadDashboard(){
      if (!currentUser) return renderLogin();
      const container = document.getElementById('app-container');
      container.innerHTML = `
        <div class="flex flex-col space-y-6 fade-in">
          <div class="flex justify-between items-center">
            <h1 class="text-2xl font-bold">My Meters</h1>
            <button onclick="openAddMeterModal()" class="bg-blue-600 text-white px-4 py-2 rounded"><i class="fa-solid fa-plus mr-2"></i>Add Meter</button>
          </div>

          <div id="meters-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="animate-pulse bg-white h-48 rounded"></div>
            <div class="animate-pulse bg-white h-48 rounded"></div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
            <div class="lg:col-span-2 bg-white p-6 rounded shadow">
              <h3 class="font-bold mb-3">Recent Transactions</h3>
              <div class="overflow-auto"><table class="w-full text-left"><thead><tr><th>Date</th><th>Meter</th><th>Token</th><th class="text-right">Amount</th></tr></thead><tbody id="history-table-body"><tr><td colspan="4" class="text-center py-4 text-gray-400">Loading...</td></tr></tbody></table></div>
            </div>
            <div class="bg-white p-6 rounded shadow">
              <h3 class="font-bold mb-3">Consumption Trend</h3>
              <p id="chart-placeholder" class="text-sm text-gray-500 text-center py-10">Select a meter to view usage</p>
              <canvas id="usageChart" class="hidden"></canvas>
            </div>
          </div>
        </div>`;

      try {
        const res = await fetch(`${API_URL}/dashboard/${currentUser.customer_id}`);
        if (!res.ok) throw new Error('Failed to load dashboard');
        const data = await res.json();

        userMeters = data.meters || [];
        renderMeters(userMeters);
        renderHistory(data.recent_transactions || []);
        if (userMeters.length > 0) loadUsageChart(userMeters[0].meter_id);
      } catch (err) {
        console.error(err);
        alert("Failed to connect to server. Is backend running?");
      }
    }

    function renderMeters(meters){
      const grid = document.getElementById('meters-grid');
      if (!meters || meters.length === 0){
        grid.innerHTML = `<div class="col-span-3 text-center py-10 text-gray-500">No meters linked to this account.</div>`;
        return;
      }
      grid.innerHTML = meters.map(m=>{
        const balance = (typeof m.current_balance === 'number') ? m.current_balance : parseFloat(m.current_balance || 0);
        return `<div class="bg-white p-6 rounded shadow">
            <div class="flex justify-between items-start mb-4">
              <div>
                <div class="text-xs text-gray-400 uppercase">Meter Number</div>
                <div class="font-mono font-bold text-lg">${m.meter_number}</div>
                <div class="text-xs text-gray-500 mt-1">${m.meter_type}</div>
              </div>
              <div class="text-right">
                <div class="text-sm text-gray-500">Balance</div>
                <div class="text-2xl font-bold text-blue-900">${balance.toFixed(4)} <span class="text-xs">units</span></div>
              </div>
            </div>
            <div class="flex gap-2">
              <button onclick="openBuyModal(${m.meter_id}, '${m.meter_number}')" class="flex-1 bg-green-600 text-white py-2 rounded">Buy Token</button>
              <button onclick="loadUsageChart(${m.meter_id})" class="flex-1 bg-gray-200 py-2 rounded">Usage</button>
            </div>
          </div>`;
      }).join('');
    }

    function renderHistory(txns){
      const tbody = document.getElementById('history-table-body');
      if (!txns || txns.length === 0){
        tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-400">No transactions.</td></tr>`;
        return;
      }
      tbody.innerHTML = txns.map(t => `<tr class="border-b">
        <td class="py-2 text-sm">${new Date(t.purchase_date).toLocaleString()}</td>
        <td class="py-2 text-sm">${t.meter_number}</td>
        <td class="py-2 text-sm font-mono">${t.generated_token}</td>
        <td class="py-2 text-right font-semibold">$${(t.amount_paid||0).toFixed(2)}</td>
      </tr>`).join('');
    }

    // Chart loader (consumption)
    async function loadUsageChart(meterId) {
    const res = await fetch(`${API_URL}/consumption/${meterId}`);
    const data = await res.json();

    const labels = data.map(d => d.date);
    const units = data.map(d => d.total_units);

    const ctx = document.getElementById('usageChart').getContext('2d');

    // Destroy previous chart if it exists
    if(window.usageChartInstance) window.usageChartInstance.destroy();

    window.usageChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Units Used',
                data: units,
                borderColor: 'rgba(59, 130, 246, 1)',
                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                fill: true,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: { title: { display: true, text: 'Date' } },
                y: { title: { display: true, text: 'Units Used' }, beginAtZero: true }
            }
        }
    });

    document.getElementById('usageChart').classList.remove('hidden');
    document.getElementById('chart-placeholder').classList.add('hidden');
}


    // Modal helpers
    function openBuyModal(meterId, meterNumber){
      document.getElementById('buy-meter-id').value = meterId;
      document.getElementById('buy-meter-number').value = meterNumber;
      document.getElementById('buy-modal').classList.remove('hidden'); document.getElementById('buy-modal').classList.add('flex');
    }
    function openAddMeterModal(){
      document.getElementById('new-meter-number').value = '';
      document.getElementById('new-meter-type').value = '';
      document.getElementById('new-meter-address').value = '';
      document.getElementById('add-meter-modal').classList.remove('hidden'); document.getElementById('add-meter-modal').classList.add('flex');
    }
    function closeModal(id){
      document.getElementById(id).classList.add('hidden'); document.getElementById(id).classList.remove('flex');
    }

    // --- Forms: Login / Register / Add meter / Buy token ---
    async function handleLogin(e){
      e.preventDefault();
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value.trim();
      try {
        const res = await fetch(`${API_URL}/login`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email,password})});
        const data = await res.json();
        if (res.ok) {
          currentUser = data.user;
          localStorage.setItem('powerpay_user', JSON.stringify(currentUser));
          renderNav(); loadDashboard();
        } else alert(data.message || data.error || 'Login failed');
      } catch (err) { console.error(err); alert('Server error'); }
    }

    async function handleRegister(e){
      e.preventDefault();
      const payload = { full_name: document.getElementById('reg-name').value.trim(),
                        email: document.getElementById('reg-email').value.trim(),
                        phone: document.getElementById('reg-phone').value.trim(),
                        password: document.getElementById('reg-password').value.trim() };
      try {
        const res = await fetch(`${API_URL}/register`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        const data = await res.json();
        if (res.ok) { alert('Registered — please login'); renderLogin(); }
        else alert(data.error || data.message || 'Registration failed');
      } catch (err) { console.error(err); alert('Server error'); }
    }

    async function handleAddMeter(e){
      e.preventDefault();
      const meterNumber = document.getElementById('new-meter-number').value.trim();
      const meterType = document.getElementById('new-meter-type').value.trim();
      const installation_address = document.getElementById('new-meter-address').value.trim() || null;
      if (!meterNumber || !meterType) return alert('Enter meter number and type');

      try {
        const res = await fetch(`${API_URL}/add-meter`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ customer_id: currentUser.customer_id, meter_number: meterNumber, meter_type: meterType, installation_address })
        });
        const data = await res.json();
        if (res.ok) {
          closeModal('add-meter-modal');
          loadDashboard();
          alert('Meter added successfully');
        } else {
          alert(data.error || data.message || 'Failed to add meter');
        }
      } catch (err) {
        console.error(err);
        alert('Server error adding meter. Is backend running?');
      }
    }

    async function handleBuyToken(e){
      e.preventDefault();
      const meter_id = parseInt(document.getElementById('buy-meter-id').value);
      const amount = parseFloat(document.getElementById('buy-amount').value);
      if (!meter_id || !amount || amount < 5) return alert('Enter a valid amount (min $5).');

      // UI
      document.getElementById('buy-btn-text').classList.add('hidden');
      document.getElementById('buy-loader').classList.remove('hidden');

      try {
        const res = await fetch(`${API_URL}/buy-token`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ meter_id, tariff_id: 1, amount })
        });
        const data = await res.json();

        if (res.ok && data.status === 'success') {
          closeModal('buy-modal');
          // stored proc returns fields like Token, UnitsAdded, NetAmountUsed
          const d = data.data || {};
          const token = d.Token || d.generated_token || '—';
          const units = parseFloat(d.UnitsAdded || d.units_purchased || 0);
          const net = parseFloat(d.NetAmountUsed || d.NetAmountUsed || amount);
          // show receipt
          document.getElementById('receipt-token').innerText = token;
          document.getElementById('receipt-units').innerText = units.toFixed(4);
          document.getElementById('receipt-cost').innerText = `$${(amount).toFixed(2)}`;
          document.getElementById('receipt-modal').classList.remove('hidden'); document.getElementById('receipt-modal').classList.add('flex');
          // refresh dashboard to show updated balance (triggered by receipt Done)
        } else {
          alert(data.message || data.error || 'Purchase failed');
        }
      } catch (err) {
        console.error(err);
        alert('Server error during purchase');
      } finally {
        document.getElementById('buy-btn-text').classList.remove('hidden');
        document.getElementById('buy-loader').classList.add('hidden');
        loadDashboard();
      }
    }
  </script>
</body>
</html>
